<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0">
<title>Stock Desk</title>
<link href="https://fonts.googleapis.com/css2?family=Syne:wght@400;700;800&family=DM+Mono:wght@300;400;500&display=swap" rel="stylesheet">
<style>
:root {
  --bg: #080808; --surface: #111; --surface2: #151515; --border: #1e1e1e; --border2: #2a2a2a;
  --text: #f0ece4; --muted: #444; --muted2: #666;
  --up: #4ade80; --down: #f87171; --flat: #94a3b8;
  --gold: #f0c060; --warn: #fb923c;
}
* { box-sizing: border-box; margin: 0; padding: 0; }
body {
  background: var(--bg); color: var(--text);
  font-family: 'DM Mono', monospace;
  min-height: 100vh;
  padding: 16px 14px 40px;
  display: flex; flex-direction: column; gap: 10px;
}

/* Header */
.header { display: flex; align-items: baseline; justify-content: space-between; padding-bottom: 8px; border-bottom: 1px solid var(--border); }
.header h1 { font-family: 'Syne', sans-serif; font-size: 1.5rem; font-weight: 800; letter-spacing: -0.03em; }
.header h1 span { color: var(--gold); }
.header-right { display: flex; flex-direction: column; align-items: flex-end; gap: 2px; }
.header-time { font-size: 0.58rem; color: var(--muted2); letter-spacing: 0.1em; }
.market-status { font-size: 0.5rem; letter-spacing: 0.08em; padding: 2px 6px; border-radius: 1px; }
.market-open   { background: rgba(74,222,128,0.1); color: var(--up); }
.market-closed { background: rgba(148,163,184,0.1); color: var(--flat); }

/* Section headers */
.section-head { display: flex; align-items: center; justify-content: space-between; margin-top: 4px; }
.section-label { font-size: 0.5rem; letter-spacing: 0.15em; text-transform: uppercase; color: var(--muted2); display: flex; align-items: center; gap: 5px; }
.pulse-dot { width: 5px; height: 5px; border-radius: 50%; background: var(--gold); display: inline-block; animation: pulse 2s ease-in-out infinite; }
.warn-dot  { width: 5px; height: 5px; border-radius: 50%; background: var(--warn); display: inline-block; animation: pulse 1s ease-in-out infinite; }
@keyframes pulse { 0%,100%{opacity:1}50%{opacity:0.2} }
.refresh-btn { font-family: 'DM Mono', monospace; font-size: 0.52rem; letter-spacing: 0.08em; text-transform: uppercase; background: none; border: 1px solid var(--border2); color: var(--muted2); padding: 3px 7px; border-radius: 2px; cursor: pointer; }
.refresh-btn:hover { border-color: var(--gold); color: var(--gold); }

/* Stock cards */
.stock-list { display: flex; flex-direction: column; gap: 3px; }

.stock-card { background: var(--surface); border: 1px solid var(--border); border-radius: 2px; overflow: hidden; transition: border-color 0.15s; }
.stock-card.top-pick { border-left: 2px solid var(--gold); }
.stock-card.abnormal { border-left: 2px solid var(--warn); }
.stock-card:hover { border-color: var(--border2); }

.card-main { display: flex; align-items: center; gap: 8px; padding: 10px 12px; cursor: pointer; }
.card-left  { flex: 1; min-width: 0; }
.card-ticker { font-family: 'Syne', sans-serif; font-weight: 700; font-size: 0.95rem; letter-spacing: -0.01em; display: flex; align-items: center; gap: 6px; }
.card-name   { font-size: 0.52rem; color: var(--muted2); margin-top: 1px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; max-width: 160px; }
.abnormal-badge { font-size: 0.45rem; letter-spacing: 0.08em; text-transform: uppercase; background: rgba(251,146,60,0.12); color: var(--warn); border: 1px solid rgba(251,146,60,0.2); padding: 1px 5px; border-radius: 1px; }

.card-spark { width: 50px; flex-shrink: 0; }
.card-right { text-align: right; min-width: 85px; flex-shrink: 0; }
.card-price  { font-size: 0.9rem; font-weight: 500; letter-spacing: -0.01em; }
.card-change { font-size: 0.58rem; margin-top: 2px; }
.card-change.up   { color: var(--up); }
.card-change.down { color: var(--down); }
.card-change.flat { color: var(--flat); }

.expand-icon { font-size: 0.6rem; color: var(--muted); transition: transform 0.2s; flex-shrink: 0; }
.stock-card.open .expand-icon { transform: rotate(180deg); }

/* Analysis drawer */
.analysis-drawer { display: none; border-top: 1px solid var(--border); padding: 10px 12px; background: var(--surface2); }
.stock-card.open .analysis-drawer { display: block; }
.analysis-loading { font-size: 0.6rem; color: var(--muted2); display: flex; align-items: center; gap: 6px; }
.spinner { display: inline-block; width: 10px; height: 10px; border: 1.5px solid var(--border2); border-top-color: var(--gold); border-radius: 50%; animation: spin 0.7s linear infinite; }
@keyframes spin { to { transform: rotate(360deg); } }

.analysis-text { font-size: 0.63rem; line-height: 1.7; color: #c0bcb4; }
.analysis-text .trend-up   { color: var(--up); }
.analysis-text .trend-down { color: var(--down); }
.analysis-text .highlight  { color: var(--text); font-weight: 500; }
.analysis-stamp { font-size: 0.48rem; color: var(--muted); margin-top: 6px; letter-spacing: 0.06em; }

/* Abnormal empty */
.empty-abnormal { border: 1px dashed var(--border); border-radius: 2px; padding: 12px; text-align: center; font-size: 0.58rem; color: var(--muted); }

/* Add ticker */
.add-row { display: flex; gap: 6px; }
.add-input { flex: 1; background: var(--surface); border: 1px solid var(--border2); color: var(--text); font-family: 'DM Mono', monospace; font-size: 0.72rem; padding: 7px 10px; border-radius: 2px; outline: none; text-transform: uppercase; letter-spacing: 0.05em; }
.add-input::placeholder { color: var(--muted); text-transform: none; letter-spacing: 0; }
.add-input:focus { border-color: var(--gold); }
.add-btn { background: var(--gold); color: #000; font-family: 'Syne', sans-serif; font-weight: 700; font-size: 0.68rem; padding: 7px 12px; border: none; border-radius: 2px; cursor: pointer; }
.add-btn:hover { background: #f5d070; }
</style>
</head>
<body>

<div class="header">
  <h1>stock <span>desk</span></h1>
  <div class="header-right">
    <div class="header-time" id="clock">--:--</div>
    <div class="market-status" id="marketStatus">--</div>
  </div>
</div>

<!-- Top 5 -->
<div class="section-head">
  <div class="section-label"><span class="pulse-dot"></span>top picks</div>
  <button class="refresh-btn" onclick="refreshAll()">↻ refresh</button>
</div>
<div class="stock-list" id="topList"></div>

<!-- Abnormal -->
<div class="section-head" style="margin-top:8px">
  <div class="section-label"><span class="warn-dot"></span>unusual moves</div>
</div>
<div id="abnormalSection">
  <div class="empty-abnormal" id="abnormalEmpty">no unusual activity detected</div>
  <div class="stock-list" id="abnormalList"></div>
</div>

<!-- Full portfolio -->
<div class="section-head" style="margin-top:8px">
  <div class="section-label">portfolio</div>
</div>
<div class="stock-list" id="portfolioList"></div>

<!-- Add ticker -->
<div class="section-head" style="margin-top:8px">
  <div class="section-label">add stock</div>
</div>
<div class="add-row">
  <input class="add-input" id="tickerInput" placeholder="ticker e.g. NVDA, BP.L" maxlength="12"
    onkeydown="if(event.key==='Enter') addTicker()">
  <button class="add-btn" onclick="addTicker()">+ ADD</button>
</div>

<script>
const TOP_PICKS = ['RKLB','ASTS','GOOGL','MVST','ONDS'];
const ALL_TICKERS = [
  'RKLB','ASTS','MDA','GOOGL','ONDS','PL','MVST','FEIM','RR',
  'ASPI','KRKNF','LUNR','AMPX','BKSY','RDW','LAES','QS','SOUN',
  'ALRT','IREN','DVLT','PLUG','RVPH'
];

// ABNORMAL thresholds
const ABNORMAL_PCT = 7;   // > 7% move = unusual
const ABNORMAL_VOL = 2.0; // > 2x avg volume = unusual (if available)

let quotes = {};        // ticker -> quote data
let analysisCache = {}; // ticker -> analysis text
let openCards = new Set();
let extraTickers = [];  // user-added

// ── UTILS ────────────────────────────────────────────────────────────────────
const pad = n => String(n).padStart(2,'0');
function updateClock() {
  const n = new Date();
  document.getElementById('clock').textContent = pad(n.getHours())+':'+pad(n.getMinutes());
  // Market status (rough: NYSE 14:30-21:00 UTC)
  const utcH = n.getUTCHours(), utcM = n.getUTCMinutes();
  const utcMins = utcH*60+utcM;
  const isWeekday = n.getUTCDay() >= 1 && n.getUTCDay() <= 5;
  const open = isWeekday && utcMins >= 870 && utcMins < 1260; // 14:30-21:00
  const el = document.getElementById('marketStatus');
  el.textContent = open ? 'NYSE OPEN' : 'NYSE CLOSED';
  el.className = 'market-status ' + (open ? 'market-open' : 'market-closed');
}
updateClock(); setInterval(updateClock, 10000);

function fmtPrice(p, currency) {
  if (p == null) return '—';
  const sym = currency === 'GBp' ? 'p' : currency === 'GBP' ? '£' : currency === 'EUR' ? '€' : '$';
  return sym + p.toFixed(currency === 'GBp' ? 0 : 2);
}

function sparkSVG(data, isUp) {
  if (!data || data.length < 2) return '';
  const min = Math.min(...data), max = Math.max(...data), range = max - min || 1;
  const w = 50, h = 24;
  const pts = data.map((v,i) => `${(i/(data.length-1))*w},${h - ((v-min)/range)*(h-4) - 2}`).join(' ');
  const color = isUp ? '#4ade80' : '#f87171';
  return `<svg width="${w}" height="${h}" viewBox="0 0 ${w} ${h}"><polyline points="${pts}" fill="none" stroke="${color}" stroke-width="1.5" stroke-linejoin="round" stroke-linecap="round"/></svg>`;
}

// ── FETCH ────────────────────────────────────────────────────────────────────
async function fetchQuote(ticker) {
  const yahooUrl = `https://query1.finance.yahoo.com/v8/finance/chart/${encodeURIComponent(ticker)}?interval=1d&range=5d`;
  const proxies = [
    `https://api.allorigins.win/get?url=${encodeURIComponent(yahooUrl)}`,
    `https://corsproxy.io/?${encodeURIComponent(yahooUrl)}`,
    `https://api.codetabs.com/v1/proxy?quest=${encodeURIComponent(yahooUrl)}`
  ];

  let lastErr;
  for (const proxy of proxies) {
    try {
      const res = await fetch(proxy, { signal: AbortSignal.timeout(8000) });
      if (!res.ok) continue;
      const json = await res.json();
      // allorigins wraps in {contents:}, corsproxy/codetabs return raw
      const raw = json.contents !== undefined ? json.contents : JSON.stringify(json);
      const data = JSON.parse(typeof raw === 'string' ? raw : JSON.stringify(raw));
      const meta = data?.chart?.result?.[0]?.meta;
      if (!meta) continue;
      const price = meta.regularMarketPrice;
      const prev  = meta.chartPreviousClose || meta.previousClose;
      const change = price - prev;
      const changePct = (change / prev) * 100;
      const closes = data?.chart?.result?.[0]?.indicators?.quote?.[0]?.close?.filter(Boolean) || [];
      return {
        ticker: ticker.toUpperCase(),
        name: meta.longName || meta.shortName || ticker,
        price, change, changePct,
        currency: meta.currency || 'USD',
        sparkData: closes.slice(-5)
      };
    } catch(e) { lastErr = e; }
  }
  throw lastErr || new Error('all proxies failed');
}

async function loadAllQuotes() {
  const all = [...new Set([...ALL_TICKERS, ...extraTickers])];
  // Load in parallel batches of 5
  for (let i = 0; i < all.length; i += 5) {
    const batch = all.slice(i, i+5);
    await Promise.all(batch.map(async t => {
      try { quotes[t] = await fetchQuote(t); }
      catch(e) { quotes[t] = { ticker: t, name: 'unavailable', price: null, changePct: null }; }
    }));
    renderAll();
  }
}

// ── ABNORMAL DETECTION ───────────────────────────────────────────────────────
function getAbnormal() {
  return Object.values(quotes).filter(q =>
    q.changePct != null && Math.abs(q.changePct) >= ABNORMAL_PCT
  ).sort((a,b) => Math.abs(b.changePct) - Math.abs(a.changePct));
}

// ── RENDER ───────────────────────────────────────────────────────────────────
function buildCard(q, extraClass = '') {
  if (!q) return '';
  const isUp  = q.changePct >= 0;
  const cls   = q.changePct > 0.05 ? 'up' : q.changePct < -0.05 ? 'down' : 'flat';
  const arrow = cls === 'up' ? '▲' : cls === 'down' ? '▼' : '—';
  const isOpen = openCards.has(q.ticker);
  const abBadge = extraClass === 'abnormal' ? `<span class="abnormal-badge">unusual</span>` : '';
  const analysis = analysisCache[q.ticker];

  return `<div class="stock-card ${extraClass} ${isOpen ? 'open' : ''}" id="card-${q.ticker}">
    <div class="card-main" onclick="toggleCard('${q.ticker}')">
      <div class="card-left">
        <div class="card-ticker">${q.ticker} ${abBadge}</div>
        <div class="card-name">${q.name || ''}</div>
      </div>
      <div class="card-spark">${sparkSVG(q.sparkData, isUp)}</div>
      <div class="card-right">
        <div class="card-price">${fmtPrice(q.price, q.currency)}</div>
        <div class="card-change ${cls}">${arrow} ${q.changePct != null ? Math.abs(q.changePct).toFixed(2)+'%' : '—'}</div>
      </div>
      <div class="expand-icon">▼</div>
    </div>
    <div class="analysis-drawer">
      ${analysis
        ? `<div class="analysis-text">${analysis}</div><div class="analysis-stamp">ai · 3-month outlook · claude</div>`
        : `<div class="analysis-loading"><span class="spinner"></span>analysing ${q.ticker}…</div>`
      }
    </div>
  </div>`;
}

function renderAll() {
  // Top picks
  document.getElementById('topList').innerHTML =
    TOP_PICKS.map(t => buildCard(quotes[t], 'top-pick')).join('');

  // Abnormal
  const abn = getAbnormal().filter(q => !TOP_PICKS.includes(q.ticker));
  document.getElementById('abnormalEmpty').style.display = abn.length ? 'none' : 'block';
  document.getElementById('abnormalList').innerHTML = abn.map(q => buildCard(q, 'abnormal')).join('');

  // Portfolio (everything except top picks and abnormal)
  const abnTickers = new Set(abn.map(q => q.ticker));
  const portfolio = [...new Set([...ALL_TICKERS, ...extraTickers])]
    .filter(t => !TOP_PICKS.includes(t) && !abnTickers.has(t));
  document.getElementById('portfolioList').innerHTML =
    portfolio.map(t => buildCard(quotes[t] || { ticker: t, name: '...', price: null, changePct: null })).join('');
}

// ── CARD TOGGLE & ANALYSIS ───────────────────────────────────────────────────
async function toggleCard(ticker) {
  if (openCards.has(ticker)) {
    openCards.delete(ticker);
    renderAll();
    return;
  }
  openCards.add(ticker);
  renderAll();

  if (analysisCache[ticker]) return; // already fetched

  // Fetch analysis
  try {
    const q = quotes[ticker];
    const priceCtx = q?.price ? `Current price: ${fmtPrice(q.price, q.currency)}, ${q.changePct?.toFixed(2)}% today.` : '';
    const response = await fetch('https://api.anthropic.com/v1/messages', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({
        model: 'claude-sonnet-4-20250514',
        max_tokens: 1000,
        tools: [{ type: 'web_search_20250305', name: 'web_search' }],
        system: `You are a concise stock analyst giving a 3-month performance summary. 
Search for recent news and price performance for the given stock.
Respond with EXACTLY 3 lines of plain text (no markdown, no bullets, no headers).
Line 1: What happened to the price over the last 3 months (up/down how much, key driver).
Line 2: The single most important recent news or catalyst.
Line 3: Outlook — one sentence on what to watch.
Keep each line under 120 characters. Be direct and specific.`,
        messages: [{ role: 'user', content: `3-month analysis for ${ticker}. ${priceCtx}` }]
      })
    });
    const data = await response.json();
    const text = data.content.filter(b => b.type === 'text').map(b => b.text).join('').trim();
    const lines = text.split('\n').filter(l => l.trim()).slice(0,3);
    analysisCache[ticker] = lines.join('<br>');
  } catch(e) {
    analysisCache[ticker] = `Analysis unavailable — ${e.message}`;
  }
  renderAll();
}

// ── ADD TICKER ───────────────────────────────────────────────────────────────
async function addTicker() {
  const input = document.getElementById('tickerInput');
  const ticker = input.value.trim().toUpperCase();
  if (!ticker || extraTickers.includes(ticker) || ALL_TICKERS.includes(ticker)) { input.value=''; return; }
  input.value = '';
  extraTickers.push(ticker);
  await saveWatchlist();
  try { quotes[ticker] = await fetchQuote(ticker); } catch(e) { quotes[ticker] = { ticker, name: 'not found', price: null, changePct: null }; }
  renderAll();
}

// ── REFRESH ──────────────────────────────────────────────────────────────────
async function refreshAll() {
  analysisCache = {};
  openCards.clear();
  await loadAllQuotes();
}

// ── INIT ─────────────────────────────────────────────────────────────────────
loadAllQuotes();
</script>
</body>
</html>
