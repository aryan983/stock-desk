<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0">
<title>EDGE — Portfolio Intelligence</title>
<link href="https://fonts.googleapis.com/css2?family=Space+Mono:wght@400;700&family=Bebas+Neue&family=Inter:wght@300;400;500&display=swap" rel="stylesheet">
<style>
:root {
  --bg: #06080f; --surface: #0c0f1a; --surface2: #111520;
  --border: #1a1f35; --border2: #242a45; --text: #e8eaf2;
  --muted: #3a4060; --muted2: #5a6080;
  --accent: #4f6ef7; --accent2: #7c5af7;
  --buy: #00e5a0; --sell: #ff4566; --news: #f7c94f;
}
* { box-sizing: border-box; margin: 0; padding: 0; }
body { background: var(--bg); color: var(--text); font-family: 'Inter', sans-serif; min-height: 100vh; overflow-x: hidden; }
body::before {
  content: ''; position: fixed; inset: 0;
  background: radial-gradient(ellipse 60% 40% at 20% 20%, rgba(79,110,247,0.06) 0%, transparent 70%),
              radial-gradient(ellipse 40% 60% at 80% 80%, rgba(124,90,247,0.05) 0%, transparent 70%);
  pointer-events: none; z-index: 0;
}
.header {
  position: relative; z-index: 10; display: flex; align-items: center; justify-content: space-between;
  padding: 16px 18px 12px; border-bottom: 1px solid var(--border);
  background: rgba(6,8,15,0.8); backdrop-filter: blur(10px);
}
.logo { font-family: 'Bebas Neue', sans-serif; font-size: 1.8rem; letter-spacing: 0.12em; background: linear-gradient(135deg, #4f6ef7, #7c5af7); -webkit-background-clip: text; -webkit-text-fill-color: transparent; background-clip: text; }
.logo-sub { font-family: 'Space Mono', monospace; font-size: 0.42rem; letter-spacing: 0.25em; color: var(--muted2); text-transform: uppercase; margin-top: -4px; }
.header-right { display: flex; flex-direction: column; align-items: flex-end; gap: 2px; }
.live-badge { display: flex; align-items: center; gap: 5px; font-family: 'Space Mono', monospace; font-size: 0.48rem; letter-spacing: 0.15em; color: var(--buy); text-transform: uppercase; }
.live-dot { width: 5px; height: 5px; border-radius: 50%; background: var(--buy); animation: pulse 1.5s ease-in-out infinite; }
@keyframes pulse { 0%,100%{opacity:1;transform:scale(1)} 50%{opacity:0.4;transform:scale(0.8)} }
.header-tickers { font-family: 'Space Mono', monospace; font-size: 0.42rem; color: var(--muted2); letter-spacing: 0.08em; }
.tab-nav { position: relative; z-index: 10; display: flex; border-bottom: 1px solid var(--border); background: rgba(6,8,15,0.6); }
.tab-btn { flex: 1; padding: 10px 0; font-family: 'Space Mono', monospace; font-size: 0.55rem; letter-spacing: 0.15em; text-transform: uppercase; color: var(--muted2); background: none; border: none; cursor: pointer; border-bottom: 2px solid transparent; transition: all 0.2s; }
.tab-btn.active { color: var(--accent); border-bottom-color: var(--accent); }
.panel { display: none; position: relative; z-index: 1; }
.panel.active { display: block; }

/* TAPE */
.tape-header { padding: 12px 18px 8px; display: flex; justify-content: space-between; align-items: center; }
.tape-label { font-family: 'Space Mono', monospace; font-size: 0.48rem; letter-spacing: 0.2em; text-transform: uppercase; color: var(--muted2); }
.filter-row { display: flex; gap: 6px; padding: 0 18px 10px; flex-wrap: wrap; }
.filter-btn { font-family: 'Space Mono', monospace; font-size: 0.48rem; letter-spacing: 0.08em; text-transform: uppercase; padding: 4px 10px; border-radius: 2px; border: 1px solid var(--border2); background: none; color: var(--muted2); cursor: pointer; transition: all 0.15s; }
.filter-btn.active { border-color: var(--accent); color: var(--accent); background: rgba(79,110,247,0.08); }
.filter-btn.buy-f.active { border-color: var(--buy); color: var(--buy); background: rgba(0,229,160,0.08); }
.filter-btn.sell-f.active { border-color: var(--sell); color: var(--sell); background: rgba(255,69,102,0.08); }
.feed { padding: 0 18px 20px; display: flex; flex-direction: column; gap: 2px; }
.feed-item { background: var(--surface); border: 1px solid var(--border); border-left: 3px solid transparent; border-radius: 2px; padding: 10px 12px; animation: slideIn 0.25s ease; }
@keyframes slideIn { from { opacity: 0; transform: translateY(-4px); } to { opacity: 1; transform: translateY(0); } }
.feed-item.purchase { border-left-color: var(--buy); }
.feed-item.sale { border-left-color: var(--sell); }
.feed-top { display: flex; justify-content: space-between; align-items: center; margin-bottom: 5px; }
.feed-ticker { font-family: 'Bebas Neue', sans-serif; font-size: 1rem; letter-spacing: 0.05em; }
.feed-type { font-family: 'Space Mono', monospace; font-size: 0.42rem; letter-spacing: 0.12em; text-transform: uppercase; padding: 2px 7px; border-radius: 1px; }
.feed-type.purchase { background: rgba(0,229,160,0.1); color: var(--buy); }
.feed-type.sale { background: rgba(255,69,102,0.1); color: var(--sell); }
.feed-body { font-size: 0.67rem; color: #9098b8; line-height: 1.55; }
.feed-body strong { color: var(--text); font-weight: 500; }
.feed-meta { display: flex; justify-content: space-between; margin-top: 5px; font-family: 'Space Mono', monospace; font-size: 0.42rem; color: var(--muted); letter-spacing: 0.05em; }
.feed-amount.purchase { color: var(--buy); font-weight: 700; }
.feed-amount.sale { color: var(--sell); font-weight: 700; }
.loading-tape { padding: 30px 18px; text-align: center; font-family: 'Space Mono', monospace; font-size: 0.55rem; color: var(--muted2); letter-spacing: 0.1em; }
.loading-bar { width: 100%; height: 1px; background: var(--border); margin: 10px 0; position: relative; overflow: hidden; }
.loading-bar::after { content: ''; position: absolute; left: -40%; width: 40%; height: 100%; background: linear-gradient(90deg, transparent, var(--accent), transparent); animation: scan 1.2s linear infinite; }
@keyframes scan { to { left: 140%; } }
.status-box { margin: 0 18px; padding: 10px 12px; border-radius: 2px; font-family: 'Space Mono', monospace; font-size: 0.5rem; letter-spacing: 0.06em; line-height: 1.7; }
.status-box.error { background: rgba(255,69,102,0.08); border: 1px solid rgba(255,69,102,0.2); color: var(--sell); }
.status-box.success { background: rgba(0,229,160,0.06); border: 1px solid rgba(0,229,160,0.15); color: var(--buy); }
.status-box.warn { background: rgba(247,201,79,0.06); border: 1px solid rgba(247,201,79,0.15); color: var(--news); }

/* NETWORK */
.network-panel { padding: 12px 18px; }
.network-info { font-family: 'Space Mono', monospace; font-size: 0.48rem; letter-spacing: 0.12em; color: var(--muted2); text-transform: uppercase; margin-bottom: 12px; }
.network-info span { color: var(--accent); }
#networkCanvas { width: 100%; border: 1px solid var(--border); border-radius: 3px; background: var(--surface); touch-action: none; cursor: grab; }
#networkCanvas:active { cursor: grabbing; }
.tooltip { position: fixed; background: var(--surface2); border: 1px solid var(--border2); border-radius: 3px; padding: 8px 12px; pointer-events: none; z-index: 100; display: none; max-width: 210px; box-shadow: 0 8px 32px rgba(0,0,0,0.6); }
.tooltip-ticker { font-family: 'Bebas Neue', sans-serif; font-size: 1rem; letter-spacing: 0.05em; margin-bottom: 4px; }
.tooltip-deps { font-family: 'Space Mono', monospace; font-size: 0.45rem; color: var(--muted2); line-height: 1.6; }
.exposure-list { display: flex; flex-direction: column; gap: 2px; margin-top: 10px; }
.exposure-row { display: flex; align-items: center; justify-content: space-between; padding: 7px 12px; background: var(--surface); border: 1px solid var(--border); border-radius: 2px; cursor: pointer; transition: all 0.15s; }
.exposure-row:hover { border-color: var(--border2); }
.exposure-row.highlighted { border-color: var(--accent); background: rgba(79,110,247,0.06); }
.exposure-dep { font-family: 'Space Mono', monospace; font-size: 0.5rem; letter-spacing: 0.08em; text-transform: uppercase; }
.exposure-tickers { display: flex; gap: 4px; flex-wrap: wrap; }
.exp-ticker { font-family: 'Bebas Neue', sans-serif; font-size: 0.75rem; padding: 1px 6px; border-radius: 1px; }
.exposure-risk { font-family: 'Space Mono', monospace; font-size: 0.42rem; letter-spacing: 0.08em; }
.risk-high { color: var(--sell); } .risk-med { color: var(--news); } .risk-low { color: var(--buy); }
.insight-box { margin-top: 10px; padding: 12px; background: linear-gradient(135deg, rgba(79,110,247,0.08), rgba(124,90,247,0.05)); border: 1px solid rgba(79,110,247,0.2); border-radius: 3px; }
.insight-label { font-family: 'Space Mono', monospace; font-size: 0.42rem; letter-spacing: 0.2em; color: var(--accent); text-transform: uppercase; margin-bottom: 6px; }
.insight-text { font-size: 0.65rem; color: #9098b8; line-height: 1.6; }
.insight-text strong { color: var(--text); }
</style>
</head>
<body>

<div class="header">
  <div>
    <div class="logo">EDGE</div>
    <div class="logo-sub">Portfolio Intelligence</div>
  </div>
  <div class="header-right">
    <div class="live-badge"><span class="live-dot"></span>Live Data</div>
    <div class="header-tickers">RKLB · ASTS · GOOGL · MVST · ONDS</div>
  </div>
</div>

<div class="tab-nav">
  <button class="tab-btn active" onclick="switchTab('tape')">⬡ The Tape</button>
  <button class="tab-btn" onclick="switchTab('network')">⬡ Exposure Map</button>
</div>

<div class="panel active" id="tapePanel">
  <div class="tape-header">
    <div class="tape-label">Congressional Trades</div>
    <div style="font-family:'Space Mono',monospace;font-size:0.42rem;color:var(--muted2)" id="feedCount">—</div>
  </div>
  <div class="filter-row">
    <button class="filter-btn active" onclick="setFilter('all',this)">All</button>
    <button class="filter-btn buy-f" onclick="setFilter('purchase',this)">Buys</button>
    <button class="filter-btn sell-f" onclick="setFilter('sale',this)">Sells</button>
  </div>
  <div id="statusBox"></div>
  <div id="feedLoading" class="loading-tape">
    <div>Fetching congressional disclosures...</div>
    <div class="loading-bar"></div>
  </div>
  <div class="feed" id="feed"></div>
</div>

<div class="panel" id="networkPanel">
  <div class="network-panel">
    <div class="network-info">Tap node to highlight exposure · <span>Drag to explore</span></div>
    <canvas id="networkCanvas" height="320"></canvas>
    <div class="exposure-list" id="exposureList"></div>
    <div class="insight-box">
      <div class="insight-label">▸ Correlation Risk</div>
      <div class="insight-text" id="insightText">Calculating...</div>
    </div>
  </div>
</div>

<div class="tooltip" id="tooltip">
  <div class="tooltip-ticker" id="ttTicker"></div>
  <div class="tooltip-deps" id="ttDeps"></div>
</div>

<script>
const TICKERS = ['RKLB','ASTS','GOOGL','MVST','ONDS'];
const TICKER_INFO = {
  RKLB: { name:'Rocket Lab', color:'#4f6ef7', deps:['NASA','DoD','NRO','SPACECOM','FAA'] },
  ASTS: { name:'AST SpaceMobile', color:'#7c5af7', deps:['FCC','DoD','AT&T','Vodafone','ITU'] },
  GOOGL: { name:'Alphabet', color:'#00e5a0', deps:['EU Antitrust','DOJ','FTC','China Export','DoD Cloud'] },
  MVST: { name:'Microvast', color:'#f7c94f', deps:['DoE','China Supply','IRA Credits','EU Battery Law'] },
  ONDS: { name:'Ondas Holdings', color:'#ff4566', deps:['FAA','DoD','FRA Rail','DHS','DoE'] }
};
const DEP_RISK = {
  'NASA':'med','DoD':'high','NRO':'high','SPACECOM':'med','FAA':'med',
  'FCC':'med','AT&T':'low','Vodafone':'low','ITU':'low',
  'EU Antitrust':'high','DOJ':'high','FTC':'med','China Export':'high','DoD Cloud':'med',
  'DoE':'med','China Supply':'high','IRA Credits':'high','EU Battery Law':'med',
  'FRA Rail':'low','DHS':'med'
};
const COMMITTEE_CONTEXT = {
  'Ted Cruz':'Senate Commerce — oversees space commerce',
  'Michael McCaul':'House Foreign Affairs Committee',
  'Ken Calvert':'House Defense Appropriations',
  'Mark Warner':'Senate Intelligence Committee',
  'Maria Cantwell':'Senate Commerce, Science & Transportation',
  'Roger Wicker':'Senate Armed Services Committee',
  'Brian Mast':'House Foreign Affairs',
  'Ro Khanna':'House Armed Services Committee',
  'Sam Graves':'House Transportation & Infrastructure',
  'French Hill':'House Financial Services',
  'Nancy Pelosi':'House Minority Leader',
  'Dan Crenshaw':'House Intelligence Committee',
};

let allTrades = [], currentFilter = 'all';

function setStatus(msg, type='warn') {
  document.getElementById('statusBox').innerHTML =
    `<div class="status-box ${type}">${msg}</div>`;
}

async function loadCongressData() {
  const FINNHUB_KEY = 'd6g4m81r01qt4931hgr0d6g4m81r01qt4931hgrg';
  setStatus('Fetching congressional trades from Finnhub...');

  try {
    const from = new Date(); from.setFullYear(from.getFullYear()-1);
    const fromStr = from.toISOString().split('T')[0];
    const toStr = new Date().toISOString().split('T')[0];

    const results = await Promise.all(TICKERS.map(async ticker => {
      const url = `https://finnhub.io/api/v1/stock/congressional-trading?symbol=${ticker}&from=${fromStr}&to=${toStr}&token=${FINNHUB_KEY}`;
      const res = await fetch(url);
      if (!res.ok) throw new Error(`HTTP ${res.status} for ${ticker}`);
      const data = await res.json();
      console.log(`${ticker} raw:`, JSON.stringify((data.data||[]).slice(0,1)));
      return { ticker, trades: data.data || [] };
    }));

    allTrades = results.flatMap(({ticker, trades}) =>
      trades.map(t => ({
        ticker,
        type: (t.transactionType||'').toLowerCase().includes('sale') ? 'sale' : 'purchase',
        who: t.name || 'Unknown',
        amount: t.amountRange || (t.amount ? `$${Number(t.amount).toLocaleString()}` : '—'),
        date: t.transactionDate || '',
        disclosure_date: t.filingDate || '',
        asset: t.assetDescription || ticker
      }))
    ).sort((a,b) => new Date(b.date) - new Date(a.date));

    if (allTrades.length > 0) {
      setStatus(`✓ Finnhub · ${allTrades.length} congressional trades for your watchlist`, 'success');
      setTimeout(() => document.getElementById('statusBox').innerHTML='', 4000);
    } else {
      setStatus('✓ Finnhub connected · No congressional trades found in last 12 months for these tickers', 'warn');
    }
    renderFeed();
  } catch(e) {
    document.getElementById('feedLoading').style.display='none';
    setStatus(`Finnhub error: ${e.message}`, 'error');
  }
}

function formatDate(d) {
  if (!d) return '—';
  try { return new Date(d).toLocaleDateString('en-GB',{day:'numeric',month:'short',year:'2-digit'}); } catch{ return d; }
}

function getCtx(who) {
  for (const [n,c] of Object.entries(COMMITTEE_CONTEXT)) if (who.includes(n)) return c;
  return null;
}

function renderFeed() {
  document.getElementById('feedLoading').style.display='none';
  const filtered = currentFilter==='all' ? allTrades : allTrades.filter(t=>t.type===currentFilter);
  document.getElementById('feedCount').textContent = `${filtered.length} disclosures`;
  const feed = document.getElementById('feed');
  if (!filtered.length) { feed.innerHTML=`<div class="status-box warn">No ${currentFilter==='all'?'':''+currentFilter+' '}trades found for your watchlist in the last 12 months</div>`; return; }
  feed.innerHTML = filtered.map(item => {
    const info = TICKER_INFO[item.ticker], ctx = getCtx(item.who);
    const lag = item.disclosure_date ? ` · disclosed ${formatDate(item.disclosure_date)}` : '';
    return `<div class="feed-item ${item.type}">
      <div class="feed-top">
        <div class="feed-ticker" style="color:${info.color}">${item.ticker}</div>
        <span class="feed-type ${item.type}">${item.type==='purchase'?'▲ Buy':'▼ Sell'}</span>
      </div>
      <div class="feed-body"><strong>${item.who}</strong>${ctx?`<br><span style="color:var(--muted2);font-size:0.6rem">${ctx}</span>`:''}</div>
      <div class="feed-meta"><span>${formatDate(item.date)}${lag}</span><span class="feed-amount ${item.type}">${item.amount}</span></div>
    </div>`;
  }).join('');
}

function setFilter(f,btn) {
  currentFilter=f;
  document.querySelectorAll('.filter-btn').forEach(b=>b.classList.remove('active'));
  btn.classList.add('active');
  renderFeed();
}

// ── NETWORK ───────────────────────────────────────────────────────────────────
let nodes=[],edges=[],dragging=null,dragOffX=0,dragOffY=0,highlightedDep=null;

function initNetwork() {
  const canvas=document.getElementById('networkCanvas');
  const W=canvas.offsetWidth; canvas.width=W;
  const cx=W/2, cy=160, r=Math.min(W*0.28,100);
  TICKERS.forEach((t,i)=>{
    const a=(i/TICKERS.length)*Math.PI*2-Math.PI/2;
    nodes.push({id:t,type:'stock',x:cx+Math.cos(a)*r,y:cy+Math.sin(a)*r,color:TICKER_INFO[t].color,label:t,r:18});
  });
  const allDeps=[...new Set(TICKERS.flatMap(t=>TICKER_INFO[t].deps))];
  const dc={'DoD':'#ff4566','DOJ':'#ff4566','EU Antitrust':'#ff4566','China Export':'#ff4566','China Supply':'#ff4566','NASA':'#4f6ef7','NRO':'#4f6ef7','SPACECOM':'#4f6ef7','DoD Cloud':'#4f6ef7','FCC':'#7c5af7','FAA':'#7c5af7','FTC':'#7c5af7','FRA Rail':'#7c5af7','DHS':'#7c5af7','IRA Credits':'#f7c94f','DoE':'#f7c94f','EU Battery Law':'#f7c94f','AT&T':'#00e5a0','Vodafone':'#00e5a0','ITU':'#00e5a0'};
  allDeps.forEach((dep,i)=>{
    const a=(i/allDeps.length)*Math.PI*2, dr=Math.min(W*0.44,150);
    nodes.push({id:dep,type:'dep',x:cx+Math.cos(a)*dr+(Math.random()-0.5)*15,y:cy+Math.sin(a)*dr+(Math.random()-0.5)*15,color:dc[dep]||'#5a6080',label:dep,r:10});
  });
  TICKERS.forEach(t=>TICKER_INFO[t].deps.forEach(dep=>edges.push({from:t,to:dep})));
  renderNetwork(); setupNetworkInteraction(); buildExposureList(); buildInsight();
}

function getNode(id){return nodes.find(n=>n.id===id);}

function renderNetwork(){
  const canvas=document.getElementById('networkCanvas'),ctx=canvas.getContext('2d'),W=canvas.width,H=canvas.height;
  ctx.clearRect(0,0,W,H);
  edges.forEach(e=>{
    const f=getNode(e.from),t=getNode(e.to); if(!f||!t)return;
    const hl=highlightedDep===t.id||highlightedDep===f.id;
    ctx.beginPath();ctx.moveTo(f.x,f.y);ctx.lineTo(t.x,t.y);
    ctx.strokeStyle=hl?t.color+'bb':'rgba(40,50,80,0.5)';ctx.lineWidth=hl?1.5:0.7;ctx.stroke();
  });
  nodes.forEach(n=>{
    const hl=highlightedDep===n.id||(highlightedDep&&edges.some(e=>(e.from===n.id&&e.to===highlightedDep)||(e.to===n.id&&e.from===highlightedDep)));
    const alpha=highlightedDep?(hl?1:0.2):1;
    if(hl||!highlightedDep){const g=ctx.createRadialGradient(n.x,n.y,0,n.x,n.y,n.r*2.5);g.addColorStop(0,n.color+'28');g.addColorStop(1,'transparent');ctx.fillStyle=g;ctx.beginPath();ctx.arc(n.x,n.y,n.r*2.5,0,Math.PI*2);ctx.fill();}
    ctx.globalAlpha=alpha;
    ctx.beginPath();ctx.arc(n.x,n.y,n.r,0,Math.PI*2);ctx.fillStyle=n.type==='stock'?n.color+'22':n.color+'12';ctx.fill();
    ctx.strokeStyle=n.color;ctx.lineWidth=n.type==='stock'?2:1;ctx.stroke();
    ctx.fillStyle=n.type==='stock'?n.color:'#9098b8';
    ctx.font=n.type==='stock'?`bold ${Math.min(n.r*0.8,11)}px Bebas Neue`:`${Math.min(n.r*0.7,7.5)}px Space Mono`;
    ctx.textAlign='center';ctx.textBaseline='middle';
    ctx.fillText(n.label.length>9?n.label.slice(0,8)+'…':n.label,n.x,n.y);
    ctx.globalAlpha=1;
  });
}

function setupNetworkInteraction(){
  const canvas=document.getElementById('networkCanvas');
  function gp(e){const r=canvas.getBoundingClientRect(),sx=canvas.width/r.width,sy=canvas.height/r.height,cx=e.touches?e.touches[0].clientX:e.clientX,cy=e.touches?e.touches[0].clientY:e.clientY;return{x:(cx-r.left)*sx,y:(cy-r.top)*sy};}
  function hit(p){return nodes.find(n=>Math.hypot(n.x-p.x,n.y-p.y)<n.r+6);}
  canvas.addEventListener('mousedown',e=>{const p=gp(e),h=hit(p);if(h){dragging=h;dragOffX=h.x-p.x;dragOffY=h.y-p.y;}});
  canvas.addEventListener('touchstart',e=>{e.preventDefault();const p=gp(e),h=hit(p);if(h){dragging=h;dragOffX=h.x-p.x;dragOffY=h.y-p.y;}},{passive:false});
  function onMove(e){
    e.preventDefault&&e.preventDefault();const p=gp(e);
    if(dragging){dragging.x=p.x+dragOffX;dragging.y=p.y+dragOffY;renderNetwork();return;}
    const h=hit(p),tt=document.getElementById('tooltip');
    if(h){tt.style.display='block';const cx=e.touches?e.touches[0].clientX:e.clientX,cy=e.touches?e.touches[0].clientY:e.clientY;tt.style.left=Math.min(cx+12,window.innerWidth-220)+'px';tt.style.top=Math.max(cy-60,10)+'px';document.getElementById('ttTicker').textContent=h.id;document.getElementById('ttTicker').style.color=h.color;document.getElementById('ttDeps').textContent=h.type==='stock'?'Exposed to: '+TICKER_INFO[h.id].deps.join(', '):'Affects: '+TICKERS.filter(t=>TICKER_INFO[t].deps.includes(h.id)).join(', ');}
    else tt.style.display='none';
  }
  canvas.addEventListener('mousemove',onMove);canvas.addEventListener('touchmove',onMove,{passive:false});
  function onEnd(e){
    if(!dragging){const r=canvas.getBoundingClientRect(),p=e.changedTouches?{x:(e.changedTouches[0].clientX-r.left)*(canvas.width/r.width),y:(e.changedTouches[0].clientY-r.top)*(canvas.height/r.height)}:gp(e),h=hit(p);if(h){highlightedDep=highlightedDep===h.id?null:h.id;renderNetwork();hlExpRow(highlightedDep);}}
    dragging=null;document.getElementById('tooltip').style.display='none';
  }
  canvas.addEventListener('mouseup',onEnd);canvas.addEventListener('touchend',onEnd);
}

function buildExposureList(){
  const deps=[...new Set(TICKERS.flatMap(t=>TICKER_INFO[t].deps))].sort((a,b)=>TICKERS.filter(t=>TICKER_INFO[t].deps.includes(b)).length-TICKERS.filter(t=>TICKER_INFO[t].deps.includes(a)).length).slice(0,8);
  document.getElementById('exposureList').innerHTML=deps.map(dep=>{
    const exp=TICKERS.filter(t=>TICKER_INFO[t].deps.includes(dep)),risk=DEP_RISK[dep]||'low';
    return `<div class="exposure-row" id="exp-${dep.replace(/[\s&]/g,'-')}" onclick="hlFromList('${dep}')">
      <div class="exposure-dep">${dep}</div>
      <div class="exposure-tickers">${exp.map(t=>`<span class="exp-ticker" style="color:${TICKER_INFO[t].color};background:${TICKER_INFO[t].color}18">${t}</span>`).join('')}</div>
      <div class="exposure-risk risk-${risk}">${risk.toUpperCase()}</div>
    </div>`;
  }).join('');
}

function hlFromList(dep){highlightedDep=highlightedDep===dep?null:dep;renderNetwork();hlExpRow(highlightedDep);switchTab('network');}
function hlExpRow(dep){document.querySelectorAll('.exposure-row').forEach(r=>r.classList.remove('highlighted'));if(dep){const el=document.getElementById('exp-'+dep.replace(/[\s&]/g,'-'));if(el)el.classList.add('highlighted');}}

function buildInsight(){
  const pairs=[];
  TICKERS.forEach((t1,i)=>TICKERS.slice(i+1).forEach(t2=>{const s=TICKER_INFO[t1].deps.filter(d=>TICKER_INFO[t2].deps.includes(d));if(s.length)pairs.push({t1,t2,shared:s});}));
  const hr=pairs.filter(p=>p.shared.some(d=>DEP_RISK[d]==='high')).sort((a,b)=>b.shared.length-a.shared.length);
  const dod=TICKERS.filter(t=>TICKER_INFO[t].deps.includes('DoD'));
  let txt='';
  if(hr.length){const {t1,t2,shared}=hr[0];const hd=shared.filter(d=>DEP_RISK[d]==='high');txt+=`<strong>${t1} and ${t2}</strong> share ${hd.length} high-risk exposure${hd.length>1?'s':''}: <strong>${hd.join(', ')}</strong>. A single policy event hits both positions simultaneously. `;}
  if(dod.length>1)txt+=`<strong>${dod.join(', ')}</strong> all carry DoD budget risk — a continuing resolution or sequestration is a portfolio-wide event.`;
  document.getElementById('insightText').innerHTML=txt||'No critical shared exposures in current watchlist.';
}

function switchTab(tab){
  document.querySelectorAll('.panel').forEach(p=>p.classList.remove('active'));
  document.querySelectorAll('.tab-btn').forEach(b=>b.classList.remove('active'));
  document.getElementById(tab+'Panel').classList.add('active');
  document.querySelectorAll('.tab-btn')[tab==='tape'?0:1].classList.add('active');
  if(tab==='network'&&nodes.length===0)setTimeout(initNetwork,50);
}

loadCongressData();
</script>
</body>
</html>